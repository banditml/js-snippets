window.refinery=window.refinery||{},refinery.RefineryAPI=function(e={}){this.storage=window.localStorage,this.refineryAppToken=this.getAppTokenFromScriptTag();this.config=Object.assign({debugMode:!1,refineryHostUrl:"https://utvcbgmjyqoututafrjy.supabase.co/rest/v1/rpc/",supabasePublicApiKey:"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJyb2xlIjoiYW5vbiIsImlhdCI6MTYxODQxODU2NiwiZXhwIjoxOTMzOTk0NTY2fQ.uAM7wYbfMO8i8G5r-Mi7CFAS56ZEVicp4de6GJg_Gt0"},e),this.refineryLiveRefinementEndpoint=`${this.config.refineryHostUrl}changes_by_app_token`},refinery.RefineryAPI.prototype.setItemInStorage=function(e,t){this.storage.setItem(e,JSON.stringify(t))},refinery.RefineryAPI.prototype.getItemFromStorage=function(e){return JSON.parse(this.storage.getItem(e))},refinery.RefineryAPI.prototype.getAppTokenFromScriptTag=function(){return document.currentScript.getAttribute("appToken")},refinery.RefineryAPI.prototype.asyncGetRequest=async function(e,t={},n={}){t&&Object.keys(t).length&&(e+="?");for(const n in t){let r=t[n];if(null!=n&&null!=r){const t=typeof r;let i;e+=`${n}=${i="number"===t||"string"===t?r:encodeURIComponent(JSON.stringify(r))}&`}}const r=await fetch(e,{method:"GET",headers:n});return await r.json()},refinery.RefineryAPI.prototype.getLiveRefinement=function(){return this.asyncGetRequest(url=`${this.refineryLiveRefinementEndpoint}?app_token=${this.refineryAppToken}`,params={},headers={"Content-Type":"application/json",apikey:`${this.config.supabasePublicApiKey}`,Authorization:`Bearer ${this.config.supabasePublicApiKey}`}).then(e=>e).catch(e=>{console.error("Failed to fetch changes",e)})},refinery.RefineryAPI.prototype.applyChange=function(e){if(window.location.href===e.href){let t=document.querySelector(e.dom_path);if(t.innerHTML.trim()===e.before_html.trim())return t.innerHTML=e.after_html,!0;console.warn(`Can't apply change on '${e.before_html}' because copy doesn't match.'${e.before_html.trim()}' vs. '${t.innerHTML.trim()}'.`)}else console.warn(`\n      Can't apply change on '${e.before_html}' because href's don't match.'${e.href}' vs. '${window.location.href}'.`);return!1},refinery.RefineryAPI.prototype.cacheChanges=function(e){this.setItemInStorage(this.refineryAppToken,e)},refinery.RefineryAPI.prototype.applyChangesFromCache=function(){const e=this,t=this.getItemFromStorage(e.refineryAppToken)||[],n=new Set;return t.filter(e=>!e.deleted).forEach(t=>{e.applyChange(t)&&n.add(t.id)}),n},refinery.RefineryAPI.prototype.applyChangesFromProd=function(e){const t=this,n=[];t.getLiveRefinement().then(r=>{r.filter(e=>!e.deleted).forEach(r=>{e.has(r.id)||t.applyChange(r),n.push(r)}),t.cacheChanges(n)})};let refineryAPI=new refinery.RefineryAPI;document.addEventListener("DOMContentLoaded",e=>{const t=refineryAPI.applyChangesFromCache();refineryAPI.applyChangesFromProd(t)});
