/////////////////////////////////////////////////////////////
//////////////////////// Bandit ML //////////////////////////
/////////////////////////////////////////////////////////////

// ___________________▒▒██▒▒▒▒▒▒▒▒▒▒░░_______________________
// ___________________▒▒████████████████_____________________
// ___________________████████████████████___________________
// _________________░░████████████████████___________________
// _________________░░████░░░░░░██░░░░▒▒██___________________
// _________________░░██░░░░░░░░▓▓░░░░▒▒██___________________
// ___________________████░░░░░░░░░░░░▒▒_____________________
// ___________________▒▒██████▓▓▓▓▓▓▓▓██_____________________
// _____________________████████▓▓▓▓▓▓▓▓██___________________
// _____________________▓▓██████████████▓▓___________________
// _______________________▓▓██████████▓▓_____________________
// ___________________▒▒▒▒▒▒▓▓▓▓▓▓▓▓▒▒_______________________
// _______________▒▒▒▒▓▓▒▒▒▒▒▒▒▒▒▒▒▒▒▒░░______________████___
// ___________░░░░▒▒▒▒__▓▓▒▒▒▒▒▒▒▒▒▒▒▒▒▒______________████___
// _______░░░░__________▓▓▒▒▒▒▒▒▒▒▒▒▒▒__░░░░______░░░░_______
// _______░░░░__________▓▓▒▒▒▒▒▒▒▒▒▒▒▒____░░░░____░░_________
// _______░░░░__________▓▓▒▒▒▒▒▒▒▒▒▒▒▒______░░░░░░___________
// _______░░░░__________▓▓▒▒▒▒▒▒▒▒▒▒▒▒________░░░░___________
// _______▒▒▒▒__________▓▓▒▒▓▓▒▒▒▒▒▒▒▒_______________________
// _______████__________▓▓▓▓▓▓▒▒▒▒▒▒░░_______________________
// _______████__________▓▓▓▓▓▓▓▓░░▓▓▒▒_______________________
// _______▒▒▒▒__________▓▓▓▓▓▓▓▓▒▒▓▓▒▒_______________________
// _____________________████████████▓▓_______________________
// _____________________██▓▓______██▓▓_______________________
// _______░░____________████______▒▒██_______________________
// _____▒▒██____________████________██▒▒_____________________
// ___▓▓████████________██▒▒________░░██_____________________
// ___▓▓____▓▓▓▓████__▒▒▓▓__________░░██_____________________
// _____________▒▒▒▒██▓▓______________▒▒██___________________
// _________________░░░░______________░░██▒▒_________________
// _____________________________________▓▓██░░__░░___________
// _______________________________________████▒▒▓▓___________
// _________________________________________████_____________
// _________________________________________██_______________


function BanditAPI () {
  this.contextName = "banditMLContext";
  this.storage = window.localStorage;
}

BanditAPI.prototype.getIpAddress = function(callback) {
  return $.ajax({
      type: 'GET',
      url: 'https://api.ipify.org?format=json',
      dataType: 'json',
      success: function(response) {
        response;
      }
  });
}

BanditAPI.prototype.getContext = function() {
    return JSON.parse(this.storage.getItem(this.contextName));
}

BanditAPI.prototype.setContext = function(dict) {
    this.storage.setItem(this.contextName, JSON.stringify(dict));
}

BanditAPI.prototype.clearContext = function() {
    this.storage.removeItem(this.contextName);
}

BanditAPI.prototype.updateContext = function(dict) {
    var context = this.getContext();
    if (context == null) {
      context = dict;
    } else {
      context = Object.assign({}, context, dict);
    }
    this.setContext(context);
}

BanditAPI.prototype.getDecision = function(experimentId) {
    // make ajax? call to gradient-app
    // how to know which experiment?

    // set the IP address before making a decision and logging context
    var ip = this.getIpAddress();
    ip.then(data => this.updateContext({ip: data.ip}));

    return {
      id: "abc123", // to join reward on
      decision: [
        "VPN",
        "Easy WP",
        "SSL"
      ]
    }
}

BanditAPI.prototype.logReward = function(decisionId, reward) {
  // make ajax? call to gradient-app
  console.log(this.getContext(), decisionId, reward);
}

var bandit = new BanditAPI()
